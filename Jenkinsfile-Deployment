pipeline {
    agent any

    parameters {
        choice(
            name: 'ACTION',
            choices: ['up', 'down'],
            description: 'Docker Compose Action: "up" to deploy or "down" to remove',
            //defaultValue: "up"
        )
    }

    environment {
        // Docker and Docker Compose configuration
        DOCKER_BUILDKIT = '1'
        COMPOSE_DOCKER_CLI_BUILD = '1'
    }

    stages {
        // Stage 1: Git Clone using SCM
        stage('Stage 1: Git Clone') {
            steps {
                checkout scm
                echo '‚úÖ Repository cloned successfully using SCM'
                sh 'git log -1 --oneline'
            }
        }

        // Stage 2: Validate Files
        stage('Stage 2: Validate Configuration Files') {
            steps {
                script {
                    echo 'üîç Validating required files...'
                    
                    def requiredFiles = [
                        'app/app.py',
                        'app/requirements.txt',
                        'app/Dockerfile',
                        'app/docker-compose.yml',
                        'app/templates/login.html',
                        'app/templates/registration.html',
                        'app/templates/index.html'
                    ]
                    
                    requiredFiles.each { file ->
                        if (!fileExists(file)) {
                            error("‚ùå Required file not found: ${file}")
                        }
                        echo "‚úÖ Found: ${file}"
                    }
                    
                    echo '‚úÖ All required files validated'
                }
            }
        }

        // Stage 3: Copy app/* to Application-VM
        stage('Stage 3: Copy App Files to Application-VM') {
            steps {
                script {
                    // Fetch AppVM IP from ansible/inventory.ini
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    if (!appIP) {
                        error('‚ùå Failed to extract AppVM IP from ansible/inventory.ini')
                    }
                    
                    echo "üì° AppVM IP: ${appIP}"
                    echo "üì¶ Copying app/* files to Application-VM (${appIP})..."
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            # Create app directory on remote VM
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} 'mkdir -p /home/ubuntu/app'
                            
                            # Copy app/* directory to Application-VM
                            rsync -avz --delete -e "ssh -i \$SSH_KEY -o StrictHostKeyChecking=no" \
                                app/ ubuntu@${appIP}:/home/ubuntu/app/
                            
                            echo "‚úÖ App files copied successfully to Application-VM (${appIP})"
                        """
                    }
                }
            }
        }

        // Stage 4: Verify Docker and Docker Compose on Remote VM
        stage('Stage 4: Verify Docker Environment') {
            when {
                expression { params.ACTION == 'up' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                echo "üîç Verifying Docker and Docker Compose installation..."
                                
                                # Check Docker
                                if ! command -v docker &> /dev/null; then
                                    echo "‚ùå Docker is not installed"
                                    exit 1
                                fi
                                docker --version
                                
                                # Check Docker Compose
                                if ! command -v docker-compose &> /dev/null; then
                                    echo "‚ùå Docker Compose is not installed"
                                    exit 1
                                fi
                                docker-compose --version
                                
                                # Check if Docker daemon is running
                                if ! docker info &> /dev/null; then
                                    echo "‚ùå Docker daemon is not running"
                                    exit 1
                                fi
                                
                                echo "‚úÖ Docker and Docker Compose are ready"
EOF
                        """
                    }
                }
            }
        }

        // Stage 5: Stop Existing Containers
        stage('Stage 5: Stop Existing Containers') {
            when {
                expression { params.ACTION == 'up' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                cd /home/ubuntu/app
                                
                                echo "üõë Stopping existing containers..."
                                docker-compose down || true
                                
                                # Remove any orphaned containers
                                docker-compose down --remove-orphans || true
                                
                                echo "‚úÖ Existing containers stopped"
EOF
                        """
                    }
                }
            }
        }

        // Stage 6: Build Docker Images
        stage('Stage 6: Build Docker Images') {
            when {
                expression { params.ACTION == 'up' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                cd /home/ubuntu/app
                                
                                echo "üõ†Ô∏è Building Docker images using docker-compose..."
                                echo "üìã Building Flask application image..."
                                
                                # Build images with no cache for fresh build
                                docker-compose build --no-cache
                                
                                echo "‚úÖ Docker images built successfully"
                                
                                # List built images
                                docker images | grep -E "(flask_app|mysql)" || true
EOF
                        """
                    }
                }
            }
        }

        // Stage 7: Start Containers with Docker Compose
        stage('Stage 7: Deploy with Docker Compose') {
            when {
                expression { params.ACTION == 'up' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                cd /home/ubuntu/app
                                
                                echo "üöÄ Starting containers with docker-compose..."
                                
                                # Start containers in detached mode
                                docker-compose up -d
                                
                                echo "‚è≥ Waiting for services to be ready..."
                                sleep 15
                                
                                echo "‚úÖ Containers started"
EOF
                        """
                    }
                }
            }
        }

        // Stage 8: Verify Deployment
        stage('Stage 8: Verify Deployment') {
            when {
                expression { params.ACTION == 'up' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                cd /home/ubuntu/app
                                
                                echo "üìä Checking container status..."
                                docker-compose ps
                                
                                echo ""
                                echo "üîç Checking container health..."
                                
                                # Check if containers are running
                                if docker-compose ps | grep -q "Up"; then
                                    echo "‚úÖ Containers are running"
                                else
                                    echo "‚ùå Some containers are not running"
                                    docker-compose ps
                                    exit 1
                                fi
                                
                                # Check Flask container logs
                                echo ""
                                echo "üìã Flask container logs (last 20 lines):"
                                docker-compose logs --tail=20 web || true
                                
                                # Check MySQL container logs
                                echo ""
                                echo "üìã MySQL container logs (last 10 lines):"
                                docker-compose logs --tail=10 db || true
                                
                                # Test Flask application
                                echo ""
                                echo "üåê Testing Flask application..."
                                sleep 5
                                
                                # Check if Flask is responding
                                if curl -f -s http://localhost:5000 > /dev/null 2>&1 || curl -f -s http://localhost:5000/login > /dev/null 2>&1; then
                                    echo "‚úÖ Flask application is responding"
                                else
                                    echo "‚ö†Ô∏è Warning: Flask application may not be ready yet"
                                fi
                                
                                echo ""
                                echo "‚úÖ Deployment verification completed"
EOF
                        """
                    }
                }
            }
        }

        // Stage 9: Docker Compose Down
        stage('Stage 9: Docker Compose Down') {
            when {
                expression { params.ACTION == 'down' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    echo "üì° AppVM IP: ${appIP}"
                    echo "üõë Stopping and removing Docker Compose containers and images..."
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                cd /home/ubuntu/app
                                
                                echo "üõë Stopping containers..."
                                docker-compose down -v || true
                                
                                echo "üóëÔ∏è Removing Docker Compose images..."
                                docker-compose down --rmi all -v || true
                                
                                echo "üßπ Cleaning up orphaned containers..."
                                docker-compose down --remove-orphans || true
                                
                                # Verify containers are stopped
                                echo ""
                                echo "üìä Container status:"
                                docker-compose ps || echo "‚úÖ No containers running"
                                
                                echo ""
                                echo "‚úÖ Docker Compose down completed successfully"
                                echo "‚úÖ All containers and images have been removed"
EOF
                        """
                    }
                }
            }
        }

        // Stage 10: Deployment Summary
        stage('Stage 10: Deployment Summary') {
            steps {
                script {
                    if (params.ACTION == 'up') {
                        def appIP = sh(
                            script: """
                                grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                            """,
                            returnStdout: true
                        ).trim()
                        
                        echo '========================================'
                        echo '‚úÖ CI/CD Deployment Pipeline Completed!'
                        echo '========================================'
                        echo "üì° Application VM: ${appIP}"
                        echo "üåê Flask Application: http://${appIP}:5000"
                        echo "üóÑÔ∏è MySQL Database: ${appIP}:3306"
                        echo '========================================'
                        echo '‚úÖ Docker Compose deployment successful'
                        echo '‚úÖ Flask + MySQL containers are running'
                        echo '‚úÖ Application is ready to accept requests'
                        echo '========================================'
                        echo ''
                        echo 'üìù Features:'
                        echo '  ‚Ä¢ Automatic user database creation on registration'
                        echo '  ‚Ä¢ User-specific databases (user_<username>)'
                        echo '  ‚Ä¢ Secure password hashing'
                        echo '  ‚Ä¢ Animated welcome page with username display'
                        echo '========================================'
                    } else {
                        echo '========================================'
                        echo '‚úÖ Docker Compose Down Completed!'
                        echo '‚úÖ All containers and images removed'
                        echo '‚úÖ Cleanup successful'
                        echo '========================================'
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                if (params.ACTION == 'up') {
                    echo '========================================'
                    echo '‚úÖ CI/CD Pipeline: SUCCESS'
                    echo '‚úÖ Flask + MySQL application deployed'
                    echo '‚úÖ Docker Compose containers running'
                    echo '‚úÖ All stages completed successfully'
                    echo '========================================'
                } else {
                    echo '========================================'
                    echo '‚úÖ CI/CD Pipeline: SUCCESS'
                    echo '‚úÖ All containers stopped and removed'
                    echo '‚úÖ Cleanup completed successfully'
                    echo '========================================'
                }
            }
        }
        failure {
            echo '========================================'
            echo '‚ùå CI/CD Pipeline: FAILED'
            echo '‚ùå Deployment pipeline encountered errors'
            echo '========================================'
        }
        always {
            echo '========================================'
            echo 'üìä CI/CD Pipeline execution completed'
            echo '========================================'
        }
    }

}
