pipeline {
    agent {label 'web-app'}

    parameters {
        choice(
            name: 'ACTION',
            choices: ['up', 'down'],
            description: 'Docker Compose Action: "up" to deploy or "down" to remove',
            //defaultValue: "up"
        )
    }

    environment {
        // Docker and Docker Compose configuration
        DOCKER_BUILDKIT = '1'
        COMPOSE_DOCKER_CLI_BUILD = '1'
    }

    stages {
        // Stage 1: Git Clone using SCM
        stage('Stage 1: Git Clone') {
            steps {
                checkout scm
                echo 'Repository cloned successfully using SCM'
                sh 'git log -1 --oneline'
            }
        }

        // Stage 2: Validate Files
        stage('Stage 2: Validate Configuration Files') {
            steps {
                script {
                    echo 'Validating required files...'
                    
                    def requiredFiles = [
                        'app/app.py',
                        'app/requirements.txt',
                        'app/Dockerfile',
                        'app/docker-compose.yml',
                        'app/templates/login.html',
                        'app/templates/registration.html',
                        'app/templates/index.html'
                    ]
                    
                    requiredFiles.each { file ->
                        if (!fileExists(file)) {
                            error("Required file not found: ${file}")
                        }
                        echo "Found: ${file}"
                    }
                    
                    echo 'All required files validated'
                }
            }
        }

        // Stage 3: Copy app/* to Application-VM
        stage('Stage 3: Copy App Files to Application-VM') {
            steps {
                script {
                    // Fetch AppVM IP from ansible/inventory.ini
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    if (!appIP) {
                        error('Failed to extract AppVM IP from ansible/inventory.ini')
                    }
                    
                    echo "AppVM IP: ${appIP}"
                    echo "Copying app/* files to Application-VM (${appIP})..."
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            # Create app directory on remote VM
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} 'mkdir -p /home/ubuntu/app'
                            
                            # Copy app/* directory to Application-VM
                            rsync -avz --delete -e "ssh -i \$SSH_KEY -o StrictHostKeyChecking=no" \
                                app/ ubuntu@${appIP}:/home/ubuntu/app/
                            
                            echo "App files copied successfully to Application-VM (${appIP})"
                        """
                    }
                }
            }
        }

        // Stage 4: Verify Docker and Docker Compose on Remote VM
        stage('Stage 4: Verify Docker Environment') {
            when {
                expression { params.ACTION == 'up' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                echo "Verifying Docker and Docker Compose installation..."
                                
                                # Check Docker
                                if ! command -v docker &> /dev/null; then
                                    echo "Docker is not installed"
                                    exit 1
                                fi
                                docker --version
                                
                                # Check Docker Compose
                                if ! command -v docker-compose &> /dev/null; then
                                    echo "Docker Compose is not installed"
                                    exit 1
                                fi
                                docker-compose --version
                                
                                # Check if Docker daemon is running
                                if ! docker info &> /dev/null; then
                                    echo "Docker daemon is not running"
                                    exit 1
                                fi
                                
                                echo "Docker and Docker Compose are ready"
EOF
                        """
                    }
                }
            }
        }

        // Stage 5: Stop Existing Containers
        stage('Stage 5: Stop Existing Containers') {
            when {
                expression { params.ACTION == 'up' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                cd /home/ubuntu/app
                                
                                echo "Stopping existing containers..."
                                docker-compose down || true
                                
                                # Remove any orphaned containers
                                docker-compose down --remove-orphans || true
                                
                                echo "Existing containers stopped"
EOF
                        """
                    }
                }
            }
        }

        // Stage 6: Build Docker Images
        stage('Stage 6: Build Docker Images') {
            when {
                expression { params.ACTION == 'up' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                cd /home/ubuntu/app
                                
                                echo "Building Docker images using docker-compose..."
                                echo "Building Flask application image..."
                                
                                # Build images with no cache for fresh build
                                docker-compose build --no-cache
                                
                                echo "Docker images built successfully"
                                
                                # List built images
                                docker images | grep -E "(flask_app|mysql)" || true
EOF
                        """
                    }
                }
            }
        }

        // Stage 7: Start Containers with Docker Compose
        stage('Stage 7: Deploy with Docker Compose') {
            when {
                expression { params.ACTION == 'up' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                cd /home/ubuntu/app
                                
                                echo "Starting containers with docker-compose..."
                                
                                # Start containers in detached mode
                                docker-compose up -d
                                
                                echo "Waiting for services to be ready..."
                                sleep 15
                                
                                echo "Containers started"
EOF
                        """
                    }
                }
            }
        }

        // Stage 8: Verify Deployment
        stage('Stage 8: Verify Deployment') {
            when {
                expression { params.ACTION == 'up' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                cd /home/ubuntu/app
                                
                                echo "Checking container status..."
                                docker-compose ps
                                
                                echo ""
                                echo "Checking container health..."
                                
                                # Check if containers are running
                                if docker-compose ps | grep -q "Up"; then
                                    echo "Containers are running"
                                else
                                    echo "Some containers are not running"
                                    docker-compose ps
                                    exit 1
                                fi
                                
                                # Check Flask container logs
                                echo ""
                                echo "Flask container logs (last 20 lines):"
                                docker-compose logs --tail=20 web || true
                                
                                # Check MySQL container logs
                                echo ""
                                echo "MySQL container logs (last 10 lines):"
                                docker-compose logs --tail=10 db || true
                                
                                # Test Flask application
                                echo ""
                                echo "Testing Flask application..."
                                sleep 5
                                
                                # Check if Flask is responding
                                if curl -f -s http://localhost:5000 > /dev/null 2>&1 || curl -f -s http://localhost:5000/login > /dev/null 2>&1; then
                                    echo "Flask application is responding"
                                else
                                    echo "Warning: Flask application may not be ready yet"
                                fi
                                
                                echo ""
                                echo "Deployment verification completed"
EOF
                        """
                    }
                }
            }
        }

        //Stage 9: To copy the docker-compose logs of service Like web & db.
        stage('Stage 9: Create DockerLogs Directory and copy logs') {
            when {
                expression { params.ACTION == 'up' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: "grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'",
                        returnStdout: true
                    ).trim()
        
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
        
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                echo "Creating docker log directories..."
                                sudo mkdir -p /home/ubuntu/app/dockerlogs
                                sudo chmod 755 /home/ubuntu/app/dockerlogs
                                sudo chown -R ubuntu:ubuntu /home/ubuntu/app/dockerlogs
                                echo "Docker log directories created at /dockerlogs"

                                cd /home/ubuntu/app

                                echo "Copy Logs From docker-compose Service web to dockerlogs directory"
                                docker-compose logs web > /home/ubuntu/app/dockerlogs/web_app.log

                                echo "Copy Logs From docker-compose Service db to dockerlogs directory"
                                docker-compose logs db > /home/ubuntu/app/dockerlogs/Mysql_db.log
EOF
                        """
                    }
                }
            }
        }

        // Stage 10: Docker Compose Down
        stage('Stage 10: Docker Compose Down') {
            when {
                expression { params.ACTION == 'down' }
            }
            steps {
                script {
                    def appIP = sh(
                        script: """
                            grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    echo "AppVM IP: ${appIP}"
                    echo "Stopping and removing Docker Compose containers and images..."
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ansible-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                            chmod 600 "\$SSH_KEY"
                            
                            ssh -o StrictHostKeyChecking=no -i "\$SSH_KEY" ubuntu@${appIP} << 'EOF'
                                cd /home/ubuntu/app
                                
                                echo "Stopping containers..."
                                docker-compose down -v || true
                                
                                echo "Removing Docker Compose images..."
                                docker-compose down --rmi all -v || true
                                
                                echo "Cleaning up orphaned containers..."
                                docker-compose down --remove-orphans || true
                                
                                # Verify containers are stopped
                                echo ""
                                echo "Container status:"
                                docker-compose ps || echo "No containers running"
                                
                                echo ""
                                echo "Docker Compose down completed successfully"
                                echo "All containers and images have been removed"
EOF
                        """
                    }
                }
            }
        }

        // Stage 11: Deployment Summary
        stage('Stage 11: Deployment Summary') {
            steps {
                script {
                    if (params.ACTION == 'up') {
                        def appIP = sh(
                            script: """
                                grep -A 1 '^\\[app\\]' ansible/inventory.ini | tail -n 1 | awk '{print \$1}'
                            """,
                            returnStdout: true
                        ).trim()
                        
                        echo '========================================'
                        echo 'CI/CD Deployment Pipeline Completed!'
                        echo '========================================'
                        echo "Application VM: ${appIP}"
                        echo "Flask Application: http://${appIP}:5000"
                        echo "MySQL Database: ${appIP}:3306"
                        echo '========================================'
                        echo 'Docker Compose deployment successful'
                        echo 'Flask + MySQL containers are running'
                        echo 'Application is ready to accept requests'
                        echo '========================================'
                        echo ''
                        echo 'Features:'
                        echo ' 1. Automatic user database creation on registration'
                        echo ' 2. User-specific databases (user_<username>)'
                        echo ' 3. Secure password hashing'
                        echo ' 4. Animated welcome page with username display'
                        echo '========================================'
                    } else {
                        echo '========================================'
                        echo 'Docker Compose Down Completed!'
                        echo 'All containers and images removed'
                        echo 'Cleanup successful'
                        echo '========================================'
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                if (params.ACTION == 'up') {
                    echo '========================================'
                    echo 'CI/CD Pipeline: SUCCESS'
                    echo 'Flask + MySQL application deployed'
                    echo 'Docker Compose containers running'
                    echo 'All stages completed successfully'
                    echo '========================================'
                } else {
                    echo '========================================'
                    echo 'CI/CD Pipeline: SUCCESS'
                    echo 'All containers stopped and removed'
                    echo 'Cleanup completed successfully'
                    echo '========================================'
                }
            }
        }
        failure {
            echo '========================================'
            echo 'CI/CD Pipeline: FAILED'
            echo 'Deployment pipeline encountered errors'
            echo '========================================'
        }
        always {
            echo '========================================'
            echo 'CI/CD Pipeline execution completed'
            echo '========================================'
        }
    }

}





